<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#fdf6e3"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#fdf6e3"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description"/><meta property="og:title" content="Pythonの環境構築奮闘記 あるいは降参の反省文"/><meta property="og:type" content="website"/><meta property="og:url" content="{DOMAIN}/posts/2019-06-16-python_env"/><meta property="og:description"/><meta property="og:image" content="https://og-image.vercel.app/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta property="og:image:alt"/><meta property="og:site_name" content="dondakeshimoの丸太"/><meta property="og:locale" content="ja_JP"/><meta property="twitter:card" content="summary_large_image"/><meta property="twitter:title" content="Pythonの環境構築奮闘記 あるいは降参の反省文"/><meta property="twitter:description"/><meta property="twitter:image" content="https://og-image.vercel.app/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta property="twitter:image:alt"/><meta property="twitter:site" content="dondakeshimo"/><meta property="twitter:creator" content="dondakeshimo"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><title>Pythonの環境構築奮闘記 あるいは降参の反省文 | dondakeshimoの丸太</title><meta property="og:image" content="/assets/blog/dynamic-routing/cover.jpg"/><meta name="next-head-count" content="31"/><link rel="preload" href="/_next/static/css/0f9d9436e0b0760d86ae.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0f9d9436e0b0760d86ae.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/framework-2191d16384373197bc0a.js" defer=""></script><script src="/_next/static/chunks/main-c034215587cd157b2989.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d2622b3552023a29a89a.js" defer=""></script><script src="/_next/static/chunks/cb1608f2-854db26f8877d6c8528f.js" defer=""></script><script src="/_next/static/chunks/a9a7754c-ecd5c258dd80f13aa656.js" defer=""></script><script src="/_next/static/chunks/349-e0275456508bca40c658.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-c414199f8f835e5668ae.js" defer=""></script><script src="/_next/static/yNrEyh5A0Oyk3eJQw5kY9/_buildManifest.js" defer=""></script><script src="/_next/static/yNrEyh5A0Oyk3eJQw5kY9/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="min-h-vfull"><main><div class="full-container mx-auto px-5"><a class="text-l font-bold text-tight mb-xl mt-l"><a class="logo" href="/"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="hand-point-up" class="svg-inline--fa fa-hand-point-up fa-w-12 svg-l dondake-icon" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M135.652 0c23.625 0 43.826 20.65 43.826 44.8v99.851c17.048-16.34 49.766-18.346 70.944 6.299 22.829-14.288 53.017-2.147 62.315 16.45C361.878 158.426 384 189.346 384 240c0 2.746-.203 13.276-.195 16 .168 61.971-31.065 76.894-38.315 123.731C343.683 391.404 333.599 400 321.786 400H150.261l-.001-.002c-18.366-.011-35.889-10.607-43.845-28.464C93.421 342.648 57.377 276.122 29.092 264 10.897 256.203.008 242.616 0 224c-.014-34.222 35.098-57.752 66.908-44.119 8.359 3.583 16.67 8.312 24.918 14.153V44.8c0-23.45 20.543-44.8 43.826-44.8zM136 416h192c13.255 0 24 10.745 24 24v48c0 13.255-10.745 24-24 24H136c-13.255 0-24-10.745-24-24v-48c0-13.255 10.745-24 24-24zm168 28c-11.046 0-20 8.954-20 20s8.954 20 20 20 20-8.954 20-20-8.954-20-20-20z"></path></svg>dondakeshimoの丸太</a></a><article class="mb-2xl"><h1 class="title text-xl font-bold mb-l text-center">Pythonの環境構築奮闘記 あるいは降参の反省文</h1><div class="container-80 mx-auto"><div class="mb-l text-l"><time dateTime="2019-06-16">June	16, 2019</time></div></div><div class="container-80 mx-auto"><div><h1 id="目次">目次</h1>
<ul>
<li><a href="#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">モチベーション</a></li>
<li><a href="#%E7%8F%BE%E7%8A%B6%E3%81%AE%E8%80%83%E5%AF%9F">現状の考察</a>
<ul>
<li>
<ul>
<li><a href="#%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%83%84%E3%83%BC%E3%83%AB">環境構築ツール</a></li>
<li><a href="#%E5%BF%85%E8%A6%81%E4%BA%8B%E9%A0%85">必要事項</a>
<ul>
<li>
<ul>
<li><a href="#python%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%AE%E4%BD%BF%E3%81%84%E5%88%86%E3%81%91">Pythonバージョンの使い分け</a></li>
<li><a href="#python%E4%BB%AE%E6%83%B3%E7%92%B0%E5%A2%83%E3%81%AE%E7%8B%AC%E7%AB%8B%E6%80%A7">Python仮想環境の独立性</a></li>
<li><a href="#python%E4%BB%AE%E6%83%B3%E7%92%B0%E5%A2%83%E3%81%AE%E5%86%8D%E7%8F%BE%E6%80%A7%E5%8F%8A%E3%81%B3%E6%89%8B%E8%BB%BD%E3%81%95">Python仮想環境の再現性及び手軽さ</a></li>
<li><a href="#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%AE%E3%82%B9%E3%83%88%E3%83%AC%E3%82%B9%E3%83%95%E3%83%AA%E3%83%BC">開発環境のストレスフリー</a></li>
<li><a href="#%E6%AC%B2%E3%81%97%E3%81%84%E7%92%B0%E5%A2%83%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81">欲しい環境のまとめ</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9%E3%81%AE%E8%80%83%E5%AF%9F">ベストプラクティスの考察</a>
<ul>
<li>
<ul>
<li><a href="#atom-hydrogen%E3%81%8C%E5%A5%BD%E3%81%8D%E3%81%A7%E3%81%99%E3%83%9D%E3%82%A8%E3%83%A0%E5%BC%B7%E3%82%81">Atom(+ Hydrogen)が好きです(ポエム強め)</a></li>
<li><a href="#pipenv-venv-virtualenv-pyenv-vritualenv-%E3%81%A0%E3%81%A8%E3%82%84%E3%81%AF%E3%82%8A">pipenv, venv, virtualenv, pyenv-vritualenv だとやはり...</a></li>
<li><a href="#anaconda%E3%81%AB%E5%A7%94%E3%81%AD%E3%82%8B">anacondaに委ねる</a></li>
<li><a href="#docker%E7%AD%89%EF%BC%8C%E4%B8%8A%E4%BD%8D%E3%81%AE%E4%BB%AE%E6%83%B3%E7%92%B0%E5%A2%83%E3%81%A7%E6%88%A6%E3%81%86">docker等，上位の仮想環境で戦う</a></li>
<li><a href="#pyenv--pyenv-virtualenv-%E3%81%AF%E3%82%84%E3%81%A3%E3%81%B1%E3%82%8A%E3%81%82%E3%82%8A%E3%81%A7%E3%81%AF">pyenv + pyenv-virtualenv はやっぱりありでは</a></li>
<li><a href="#pyenv--pipenv-%E3%81%AF%E6%AC%A1%E4%B8%96%E4%BB%A3%E3%81%BF%E3%81%8C%E3%81%82%E3%82%8B">pyenv + pipenv は次世代みがある</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
</ul>
<h1 id="モチベーション">モチベーション</h1>
<p>Pythonは最高だ！
コードの見た目は綺麗で，3rdパーティモジュールも豊富，
何よりもiPython kernelの存在が大きいと思う．
もっというとJupyterだ．
あるいばHydrogen(Atom package)だ．
ブラウザでもお好きなブラウザでもコードを書きながら即時実行できる強みは計り知れない．</p>
<p>しかし，Pythonの環境構築周辺はとっちらかっている．
議論もベストプラクティスもハゲ散らかっている．
Pythonの環境構築について思い悩んだ挙句，
一旦思考をまとめるのと思考の記録を残す目的で本ログを残す．
(注: ほぼポエム)</p>
<h1 id="現状の考察">現状の考察</h1>
<h3 id="環境構築ツール">環境構築ツール</h3>
<p>下記サイトなど色々なサイトでまとめられているため，まとめのまとめレベルで記述する．</p>
<p>[https://qiita.com/KRiver1/items/c1788e616b77a9bad4dd#pipenv:title]</p>
<p>| |Pythonバージョン切り替え|パッケージ切り替え|
|:---|---|---|
|pyenv|◯||
|pyenv-virtualenv||◯|
|venv||◯|
|virtualenv||◯|
|pipenv||◯|
|anaconda|◯|◯|
|docker|◯|◯|</p>
<h3 id="必要事項">必要事項</h3>
<ul>
<li>Pythonバージョンの使い分け</li>
<li>Python仮想環境の独立性</li>
<li>Python仮想環境の再現性及び手軽さ</li>
<li>開発環境のストレスフリー</li>
</ul>
<p>ここでPython仮想環境とはvirtual envやpipenvで作成した環境を指す．</p>
<h5 id="pythonバージョンの使い分け">Pythonバージョンの使い分け</h5>
<p>絶対に必要がどうかは疑わしいという議論もある．
しかし，導入自体はツールさえインストールしてしまえば簡単にでき，
tensorflowなどのPythonバージョンに依存するモジュール(知識が古かったらすみません)
も容易に使えるようになることや，
実行環境のPythonバージョンが固定されている時のことなども考えると
あって損はない機能というか，やっぱり必要機能だと感じる．</p>
<h5 id="python仮想環境の独立性">Python仮想環境の独立性</h5>
<p>これはどこまで仮想環境を切り分けるかという話である．
例えば，pyenvのみを用いた場合はバージョン毎の切り分けは可能だが，
プロジェクト単位での環境の切り分けはできない．
しかし，プロジェクトの依存関係がはっきりしないプロジェクトというのは，
個人開発の域を出た瞬間になんとも言えない不安感を煽る．
イケてないと感じるし，イケてない人だと苦笑いされるのは最悪の気分だ．</p>
<h5 id="python仮想環境の再現性及び手軽さ">Python仮想環境の再現性及び手軽さ</h5>
<p>上述の独立性を担保する上で，留意しておきたい点がこの二つである．
独立性を担保し，依存関係がはっきりしていることは非常に好ましいが，
さらにその仮想環境を違うマシン，環境でも簡単にサクッと再現できる必要がある．
著者は古くからの <code>requirements.txt</code> はとても好きだ．
Simple is best だ．
逆に自分にとって手軽だろうが，自前のシェルスクリプトなどは再現性が下がるので論外となる．</p>
<h5 id="開発環境のストレスフリー">開発環境のストレスフリー</h5>
<p>ざっくり分けて環境には2種類あり，
それぞれ開発環境と実行環境に分けられる．
ここで議論している環境は実行環境を大きく意識した開発環境を整えることである．
しかし，実行環境のために開発環境の便利さをトレードオフさせることは避けたい，いやだ，ありえない．</p>
<h5 id="欲しい環境のまとめ">欲しい環境のまとめ</h5>
<p>実行環境を意識した上で，バージョンと依存関係がプロジェクト単位で独立しており，
その仮想環境を他の環境でも容易に再構築できるが，
それら全ては開発環境の機能を損なうものであってはならない．</p>
<h1 id="ベストプラクティスの考察">ベストプラクティスの考察</h1>
<ul>
<li>Atom(+ Hydrogen)が好きです</li>
<li>pipenv, venv, virtualenv, pyenv-virtualenv だとやはり...</li>
<li>anacondaに委ねる</li>
<li>docker等，上位の仮想環境で戦う</li>
<li>pyenv + pyenv-virtualenv はやっぱりありでは</li>
<li>pyenv + pipenv は次世代みがある</li>
</ul>
<h3 id="atom-hydrogenが好きですポエム強め">Atom(+ Hydrogen)が好きです(ポエム強め)</h3>
<p>いきなり個人の趣向が入ってきて，ベストプラクティス(笑)になってしまった．
Atom + HydrogenはAtomエディタ上でiPythonを用い，
各行実行や，セクション実行が可能なプラグインである．
布教が目的とかではないけど是非使ってみてほしい．惚れると思う．</p>
<p>さて，このプラグインを実行するためにはJupyter環境が必要になるのだが，これが曲者である．
Jupyter入れるだけでしまいやん！とはならない．
上記の必要事項にプロジェクト毎の独立性と書いたが，
その要件を満たした場合，Hydrogenの実行カーネルを
それぞれのプロジェクトに対して変更する必要がある．
...だが，無理だ．
そのような機能は，ない．
管理手法がそれぞれ異なるのにそのような出すぎた要求はできない．</p>
<p>そのため，筆者はどのプロジェクトでも使える共通の，なんでも入りの仮想環境を一つ作り，
そのカーネルをHydrogenに登録して用いている．
どう考えても，実行環境と開発環境に乖離が生じているためダメだろうという構成である．
仮想環境は最後にその構成で動くかどうか確認し，他人と共有する為のものと化してしまっている．</p>
<p>Jupyterで開発している人もどうしているのだろうか．
全てのプロジェクトにJupyter入れているんだろうか？</p>
<p>Hydrogenを諦めればなんでも綺麗にまとまる気がしてきた．
しかし，必要事項の開発環境のストレスフリーに反する為，
結局筆者はこのような環境を現状使い続けるだろう．
Hydrogenのカーネルを仮想環境毎に割り振るツールでも作れば良いのだろうが...
あれ，それで解決するのでは？
来週の予定，埋まりました．</p>
<h3 id="pipenv-venv-virtualenv-pyenv-vritualenv-だとやはり">pipenv, venv, virtualenv, pyenv-vritualenv だとやはり...</h3>
<blockquote>
<p>pipenv，ナウいんだろう，知らんけど．</p>
</blockquote>
<p>という所感を環境構築のリサーチ中に受けた．
これら4つはPythonのバージョン管理は機能として持っておらず，
Python仮想環境の構築にのみ特化したものである．
基本的な機能はどれも同じで，少し前までのデファクトがvirtualenv，
最近評価をあげているのがpipenvという印象である．
正直どれでも良い気もするし，venvには触ったことがないしおすすめ出てこないしで一旦スルーする．</p>
<p>pipenvはnpm(JavaScriptの似たような機能のやつ)などの影響を受けているらしい？
必要パッケージだけでなくその依存モジュールまで記録してくれる．
npmのようにその環境独自のコマンドを用意することもできる．
最も後発で，機能としては最も完璧に近いと思う．
ただ，遅い．依存関係の記録が異常に遅い．ついでに毎回最初に
<code>pipenv run</code> つけるの面倒くさい．
<code>pipenv shell</code> はわかりづらい．</p>
<p>virtualenvやpyenv-virtualenvは再現性がpipenvと比べて低い．
pipenvでは <code>pipenv install</code> の1コマンドで済むところを
それぞれの開発者がrequests.txtに応じて開発環境を構築することが必要となる．
逆に開発者それぞれにpipenvの依存関係が軽減されるということでもある．
pyenv-virtualenvの方が手軽だが，
多数のプロジェクトを抱える場合，環境の中央集中の一括管理であるため取っ散らかる．
virtualenvはactivateするのが面倒だったり，環境の使い回しができないデメリットがある．</p>
<p>やはり...とかなかった．
一長一短だった．
最初はpipenvに落ち着けるつもりだったけど，
書き始めたらむしろ愚痴の方が出てきたため保留．</p>
<h3 id="anacondaに委ねる">anacondaに委ねる</h3>
<p>anacondaは全部やってくれる．
マジで全部．本当に全部．全然全部．
以前はWindows環境の場合，その他のツールが動かないため，
anaconda以外の選択肢がなかったし，
実際これさえあればかなりほぼ全ての要求に答えることができる．
じゃあ，これでええやん！とならないのがややこしいところである．</p>
<p>anacondaそのものの是非について</p>
<p>[https://team-6.hatenablog.jp/entry/2017/08/24/040451]</p>
<p>この辺に議論が書いてある．
多分批判点(メリット)をざっくりまとめると</p>
<ul>
<li>権限周りの危険が危ない説がある</li>
<li>大量のパッケージを入れられて容量とかうざい(大量のパッケージ美味しい)</li>
<li>pipと競合する(condaの方が楽にインストールできるものも存在する(した))</li>
</ul>
<p>この辺に突っ込むと長くなりそうだし，完全に把握しているわけではないからこの辺で飛ばす．
現状，anacondaを使うなら全てをanacondaに委ねる覚悟が必要そう．
何かと共存させるのはどうなんだろうという状態らしい．
筆者はpyenvでanacondaをインストールして使っていたが，
これは大量のパッケージが事前に入っていて便利だったからである．
その程度の理由ならとっととanacondaから撤退した方が吉だろうと思い，全部捨てた．</p>
<h3 id="docker等，上位の仮想環境で戦う">docker等，上位の仮想環境で戦う</h3>
<p>docker最高！Vagrandとかでも全然あり！
速度のオーバーヘッドはあまりないし，ここまで仮想化したら実行環境への意識という点では完璧だ．
...だが，弊環境では難しい．
一つ大きな理由がマシンの容量が怖いところである．
メインマシンがストレージ256GBのMacなのが全部悪い．
もう一つ運用できないため実際にぶち当たったことはないのだが，
開発環境でストレスが出るのではないかという懸念もある．
できればAtomで開発したいのだが，この場合ボリュームを結合するか，
何かの都度書いたスクリプトをdocker環境にコピーする必要がある．
jupyterサーバを立てる手もあるため，
そこで下書きをしながらスクリプトを書いてコピーという流れが良いのだろうか．
マシンをアップグレードすれば非常に興味のある構成なので是非ご教授願いたい．</p>
<h3 id="pyenv--pyenv-virtualenv-はやっぱりありでは">pyenv + pyenv-virtualenv はやっぱりありでは</h3>
<p>筆者が最近環境を再考するまで使用していた構成である．
そしてこの投稿を書きながら，Hydrogenを使うに最も適当な構成であると気づき．
再度この構成に落ち着かんとしている．
問題としては環境の再現性が大きいと思うし，
実際のところpipenvの方がイケてる感は否めないので他人に勧めるようなものでもない．</p>
<h3 id="pyenv--pipenv-は次世代みがある">pyenv + pipenv は次世代みがある</h3>
<p>目下ネット上の第一おすすめ候補だろう．
かっこいいし，いいと思う．
遅い問題については <code>--skip lock</code> オプションをつけることで大きく軽減されるらしい．
それでもどこかのタイミングでlockせざるを得ないが．
この問題についてはpipenvの開発者も認識しているらしく，近い将来改善されることが期待される．
もう一つの仮想環境に入るの面倒あるいわかりづらい問題は，
自分のターミナルを適応させることでなんとかなると思う．
というかそういうの考えるのは割と好き．</p>
<h1 id="まとめ">まとめ</h1>
<ul>
<li>開発環境さえ整えばdockerが最高！(と思う)</li>
<li>パッケージ管理特化のツールはpipenvが一つ抜けている気もするが，(まだ)五十歩百歩</li>
<li>anacondaは好き嫌い分かれてる</li>
<li>開発環境を完璧に整えるのはdockerに限らず難しい</li>
</ul></div></div></article></div></main></div><footer><div class="full-container mx-auto px-5"><div class="full-container mx-auto px-5"><div class="py-m sns-container my-l"><div class="mx-s github-icon"><a href="https://github.com/dondakeshimo"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div><div class="mx-s twitter-icon"><a href="https://twitter.com/dondakeshimo"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Pythonの環境構築奮闘記 あるいは降参の反省文","date":"2019-06-16","slug":"2019-06-16-python_env","author":{"name":"JJ Kasper","picture":"/assets/blog/authors/jj.jpeg"},"content":"\u003ch1 id=\"目次\"\u003e目次\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\"\u003eモチベーション\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E7%8F%BE%E7%8A%B6%E3%81%AE%E8%80%83%E5%AF%9F\"\u003e現状の考察\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%83%84%E3%83%BC%E3%83%AB\"\u003e環境構築ツール\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%BF%85%E8%A6%81%E4%BA%8B%E9%A0%85\"\u003e必要事項\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#python%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%AE%E4%BD%BF%E3%81%84%E5%88%86%E3%81%91\"\u003ePythonバージョンの使い分け\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#python%E4%BB%AE%E6%83%B3%E7%92%B0%E5%A2%83%E3%81%AE%E7%8B%AC%E7%AB%8B%E6%80%A7\"\u003ePython仮想環境の独立性\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#python%E4%BB%AE%E6%83%B3%E7%92%B0%E5%A2%83%E3%81%AE%E5%86%8D%E7%8F%BE%E6%80%A7%E5%8F%8A%E3%81%B3%E6%89%8B%E8%BB%BD%E3%81%95\"\u003ePython仮想環境の再現性及び手軽さ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%AE%E3%82%B9%E3%83%88%E3%83%AC%E3%82%B9%E3%83%95%E3%83%AA%E3%83%BC\"\u003e開発環境のストレスフリー\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%AC%B2%E3%81%97%E3%81%84%E7%92%B0%E5%A2%83%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81\"\u003e欲しい環境のまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9%E3%81%AE%E8%80%83%E5%AF%9F\"\u003eベストプラクティスの考察\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#atom-hydrogen%E3%81%8C%E5%A5%BD%E3%81%8D%E3%81%A7%E3%81%99%E3%83%9D%E3%82%A8%E3%83%A0%E5%BC%B7%E3%82%81\"\u003eAtom(+ Hydrogen)が好きです(ポエム強め)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#pipenv-venv-virtualenv-pyenv-vritualenv-%E3%81%A0%E3%81%A8%E3%82%84%E3%81%AF%E3%82%8A\"\u003epipenv, venv, virtualenv, pyenv-vritualenv だとやはり...\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#anaconda%E3%81%AB%E5%A7%94%E3%81%AD%E3%82%8B\"\u003eanacondaに委ねる\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#docker%E7%AD%89%EF%BC%8C%E4%B8%8A%E4%BD%8D%E3%81%AE%E4%BB%AE%E6%83%B3%E7%92%B0%E5%A2%83%E3%81%A7%E6%88%A6%E3%81%86\"\u003edocker等，上位の仮想環境で戦う\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#pyenv--pyenv-virtualenv-%E3%81%AF%E3%82%84%E3%81%A3%E3%81%B1%E3%82%8A%E3%81%82%E3%82%8A%E3%81%A7%E3%81%AF\"\u003epyenv + pyenv-virtualenv はやっぱりありでは\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#pyenv--pipenv-%E3%81%AF%E6%AC%A1%E4%B8%96%E4%BB%A3%E3%81%BF%E3%81%8C%E3%81%82%E3%82%8B\"\u003epyenv + pipenv は次世代みがある\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"モチベーション\"\u003eモチベーション\u003c/h1\u003e\n\u003cp\u003ePythonは最高だ！\nコードの見た目は綺麗で，3rdパーティモジュールも豊富，\n何よりもiPython kernelの存在が大きいと思う．\nもっというとJupyterだ．\nあるいばHydrogen(Atom package)だ．\nブラウザでもお好きなブラウザでもコードを書きながら即時実行できる強みは計り知れない．\u003c/p\u003e\n\u003cp\u003eしかし，Pythonの環境構築周辺はとっちらかっている．\n議論もベストプラクティスもハゲ散らかっている．\nPythonの環境構築について思い悩んだ挙句，\n一旦思考をまとめるのと思考の記録を残す目的で本ログを残す．\n(注: ほぼポエム)\u003c/p\u003e\n\u003ch1 id=\"現状の考察\"\u003e現状の考察\u003c/h1\u003e\n\u003ch3 id=\"環境構築ツール\"\u003e環境構築ツール\u003c/h3\u003e\n\u003cp\u003e下記サイトなど色々なサイトでまとめられているため，まとめのまとめレベルで記述する．\u003c/p\u003e\n\u003cp\u003e[https://qiita.com/KRiver1/items/c1788e616b77a9bad4dd#pipenv:title]\u003c/p\u003e\n\u003cp\u003e| |Pythonバージョン切り替え|パッケージ切り替え|\n|:---|---|---|\n|pyenv|◯||\n|pyenv-virtualenv||◯|\n|venv||◯|\n|virtualenv||◯|\n|pipenv||◯|\n|anaconda|◯|◯|\n|docker|◯|◯|\u003c/p\u003e\n\u003ch3 id=\"必要事項\"\u003e必要事項\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003ePythonバージョンの使い分け\u003c/li\u003e\n\u003cli\u003ePython仮想環境の独立性\u003c/li\u003e\n\u003cli\u003ePython仮想環境の再現性及び手軽さ\u003c/li\u003e\n\u003cli\u003e開発環境のストレスフリー\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eここでPython仮想環境とはvirtual envやpipenvで作成した環境を指す．\u003c/p\u003e\n\u003ch5 id=\"pythonバージョンの使い分け\"\u003ePythonバージョンの使い分け\u003c/h5\u003e\n\u003cp\u003e絶対に必要がどうかは疑わしいという議論もある．\nしかし，導入自体はツールさえインストールしてしまえば簡単にでき，\ntensorflowなどのPythonバージョンに依存するモジュール(知識が古かったらすみません)\nも容易に使えるようになることや，\n実行環境のPythonバージョンが固定されている時のことなども考えると\nあって損はない機能というか，やっぱり必要機能だと感じる．\u003c/p\u003e\n\u003ch5 id=\"python仮想環境の独立性\"\u003ePython仮想環境の独立性\u003c/h5\u003e\n\u003cp\u003eこれはどこまで仮想環境を切り分けるかという話である．\n例えば，pyenvのみを用いた場合はバージョン毎の切り分けは可能だが，\nプロジェクト単位での環境の切り分けはできない．\nしかし，プロジェクトの依存関係がはっきりしないプロジェクトというのは，\n個人開発の域を出た瞬間になんとも言えない不安感を煽る．\nイケてないと感じるし，イケてない人だと苦笑いされるのは最悪の気分だ．\u003c/p\u003e\n\u003ch5 id=\"python仮想環境の再現性及び手軽さ\"\u003ePython仮想環境の再現性及び手軽さ\u003c/h5\u003e\n\u003cp\u003e上述の独立性を担保する上で，留意しておきたい点がこの二つである．\n独立性を担保し，依存関係がはっきりしていることは非常に好ましいが，\nさらにその仮想環境を違うマシン，環境でも簡単にサクッと再現できる必要がある．\n著者は古くからの \u003ccode\u003erequirements.txt\u003c/code\u003e はとても好きだ．\nSimple is best だ．\n逆に自分にとって手軽だろうが，自前のシェルスクリプトなどは再現性が下がるので論外となる．\u003c/p\u003e\n\u003ch5 id=\"開発環境のストレスフリー\"\u003e開発環境のストレスフリー\u003c/h5\u003e\n\u003cp\u003eざっくり分けて環境には2種類あり，\nそれぞれ開発環境と実行環境に分けられる．\nここで議論している環境は実行環境を大きく意識した開発環境を整えることである．\nしかし，実行環境のために開発環境の便利さをトレードオフさせることは避けたい，いやだ，ありえない．\u003c/p\u003e\n\u003ch5 id=\"欲しい環境のまとめ\"\u003e欲しい環境のまとめ\u003c/h5\u003e\n\u003cp\u003e実行環境を意識した上で，バージョンと依存関係がプロジェクト単位で独立しており，\nその仮想環境を他の環境でも容易に再構築できるが，\nそれら全ては開発環境の機能を損なうものであってはならない．\u003c/p\u003e\n\u003ch1 id=\"ベストプラクティスの考察\"\u003eベストプラクティスの考察\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eAtom(+ Hydrogen)が好きです\u003c/li\u003e\n\u003cli\u003epipenv, venv, virtualenv, pyenv-virtualenv だとやはり...\u003c/li\u003e\n\u003cli\u003eanacondaに委ねる\u003c/li\u003e\n\u003cli\u003edocker等，上位の仮想環境で戦う\u003c/li\u003e\n\u003cli\u003epyenv + pyenv-virtualenv はやっぱりありでは\u003c/li\u003e\n\u003cli\u003epyenv + pipenv は次世代みがある\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"atom-hydrogenが好きですポエム強め\"\u003eAtom(+ Hydrogen)が好きです(ポエム強め)\u003c/h3\u003e\n\u003cp\u003eいきなり個人の趣向が入ってきて，ベストプラクティス(笑)になってしまった．\nAtom + HydrogenはAtomエディタ上でiPythonを用い，\n各行実行や，セクション実行が可能なプラグインである．\n布教が目的とかではないけど是非使ってみてほしい．惚れると思う．\u003c/p\u003e\n\u003cp\u003eさて，このプラグインを実行するためにはJupyter環境が必要になるのだが，これが曲者である．\nJupyter入れるだけでしまいやん！とはならない．\n上記の必要事項にプロジェクト毎の独立性と書いたが，\nその要件を満たした場合，Hydrogenの実行カーネルを\nそれぞれのプロジェクトに対して変更する必要がある．\n...だが，無理だ．\nそのような機能は，ない．\n管理手法がそれぞれ異なるのにそのような出すぎた要求はできない．\u003c/p\u003e\n\u003cp\u003eそのため，筆者はどのプロジェクトでも使える共通の，なんでも入りの仮想環境を一つ作り，\nそのカーネルをHydrogenに登録して用いている．\nどう考えても，実行環境と開発環境に乖離が生じているためダメだろうという構成である．\n仮想環境は最後にその構成で動くかどうか確認し，他人と共有する為のものと化してしまっている．\u003c/p\u003e\n\u003cp\u003eJupyterで開発している人もどうしているのだろうか．\n全てのプロジェクトにJupyter入れているんだろうか？\u003c/p\u003e\n\u003cp\u003eHydrogenを諦めればなんでも綺麗にまとまる気がしてきた．\nしかし，必要事項の開発環境のストレスフリーに反する為，\n結局筆者はこのような環境を現状使い続けるだろう．\nHydrogenのカーネルを仮想環境毎に割り振るツールでも作れば良いのだろうが...\nあれ，それで解決するのでは？\n来週の予定，埋まりました．\u003c/p\u003e\n\u003ch3 id=\"pipenv-venv-virtualenv-pyenv-vritualenv-だとやはり\"\u003epipenv, venv, virtualenv, pyenv-vritualenv だとやはり...\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003epipenv，ナウいんだろう，知らんけど．\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eという所感を環境構築のリサーチ中に受けた．\nこれら4つはPythonのバージョン管理は機能として持っておらず，\nPython仮想環境の構築にのみ特化したものである．\n基本的な機能はどれも同じで，少し前までのデファクトがvirtualenv，\n最近評価をあげているのがpipenvという印象である．\n正直どれでも良い気もするし，venvには触ったことがないしおすすめ出てこないしで一旦スルーする．\u003c/p\u003e\n\u003cp\u003epipenvはnpm(JavaScriptの似たような機能のやつ)などの影響を受けているらしい？\n必要パッケージだけでなくその依存モジュールまで記録してくれる．\nnpmのようにその環境独自のコマンドを用意することもできる．\n最も後発で，機能としては最も完璧に近いと思う．\nただ，遅い．依存関係の記録が異常に遅い．ついでに毎回最初に\n\u003ccode\u003epipenv run\u003c/code\u003e つけるの面倒くさい．\n\u003ccode\u003epipenv shell\u003c/code\u003e はわかりづらい．\u003c/p\u003e\n\u003cp\u003evirtualenvやpyenv-virtualenvは再現性がpipenvと比べて低い．\npipenvでは \u003ccode\u003epipenv install\u003c/code\u003e の1コマンドで済むところを\nそれぞれの開発者がrequests.txtに応じて開発環境を構築することが必要となる．\n逆に開発者それぞれにpipenvの依存関係が軽減されるということでもある．\npyenv-virtualenvの方が手軽だが，\n多数のプロジェクトを抱える場合，環境の中央集中の一括管理であるため取っ散らかる．\nvirtualenvはactivateするのが面倒だったり，環境の使い回しができないデメリットがある．\u003c/p\u003e\n\u003cp\u003eやはり...とかなかった．\n一長一短だった．\n最初はpipenvに落ち着けるつもりだったけど，\n書き始めたらむしろ愚痴の方が出てきたため保留．\u003c/p\u003e\n\u003ch3 id=\"anacondaに委ねる\"\u003eanacondaに委ねる\u003c/h3\u003e\n\u003cp\u003eanacondaは全部やってくれる．\nマジで全部．本当に全部．全然全部．\n以前はWindows環境の場合，その他のツールが動かないため，\nanaconda以外の選択肢がなかったし，\n実際これさえあればかなりほぼ全ての要求に答えることができる．\nじゃあ，これでええやん！とならないのがややこしいところである．\u003c/p\u003e\n\u003cp\u003eanacondaそのものの是非について\u003c/p\u003e\n\u003cp\u003e[https://team-6.hatenablog.jp/entry/2017/08/24/040451]\u003c/p\u003e\n\u003cp\u003eこの辺に議論が書いてある．\n多分批判点(メリット)をざっくりまとめると\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e権限周りの危険が危ない説がある\u003c/li\u003e\n\u003cli\u003e大量のパッケージを入れられて容量とかうざい(大量のパッケージ美味しい)\u003c/li\u003e\n\u003cli\u003epipと競合する(condaの方が楽にインストールできるものも存在する(した))\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eこの辺に突っ込むと長くなりそうだし，完全に把握しているわけではないからこの辺で飛ばす．\n現状，anacondaを使うなら全てをanacondaに委ねる覚悟が必要そう．\n何かと共存させるのはどうなんだろうという状態らしい．\n筆者はpyenvでanacondaをインストールして使っていたが，\nこれは大量のパッケージが事前に入っていて便利だったからである．\nその程度の理由ならとっととanacondaから撤退した方が吉だろうと思い，全部捨てた．\u003c/p\u003e\n\u003ch3 id=\"docker等，上位の仮想環境で戦う\"\u003edocker等，上位の仮想環境で戦う\u003c/h3\u003e\n\u003cp\u003edocker最高！Vagrandとかでも全然あり！\n速度のオーバーヘッドはあまりないし，ここまで仮想化したら実行環境への意識という点では完璧だ．\n...だが，弊環境では難しい．\n一つ大きな理由がマシンの容量が怖いところである．\nメインマシンがストレージ256GBのMacなのが全部悪い．\nもう一つ運用できないため実際にぶち当たったことはないのだが，\n開発環境でストレスが出るのではないかという懸念もある．\nできればAtomで開発したいのだが，この場合ボリュームを結合するか，\n何かの都度書いたスクリプトをdocker環境にコピーする必要がある．\njupyterサーバを立てる手もあるため，\nそこで下書きをしながらスクリプトを書いてコピーという流れが良いのだろうか．\nマシンをアップグレードすれば非常に興味のある構成なので是非ご教授願いたい．\u003c/p\u003e\n\u003ch3 id=\"pyenv--pyenv-virtualenv-はやっぱりありでは\"\u003epyenv + pyenv-virtualenv はやっぱりありでは\u003c/h3\u003e\n\u003cp\u003e筆者が最近環境を再考するまで使用していた構成である．\nそしてこの投稿を書きながら，Hydrogenを使うに最も適当な構成であると気づき．\n再度この構成に落ち着かんとしている．\n問題としては環境の再現性が大きいと思うし，\n実際のところpipenvの方がイケてる感は否めないので他人に勧めるようなものでもない．\u003c/p\u003e\n\u003ch3 id=\"pyenv--pipenv-は次世代みがある\"\u003epyenv + pipenv は次世代みがある\u003c/h3\u003e\n\u003cp\u003e目下ネット上の第一おすすめ候補だろう．\nかっこいいし，いいと思う．\n遅い問題については \u003ccode\u003e--skip lock\u003c/code\u003e オプションをつけることで大きく軽減されるらしい．\nそれでもどこかのタイミングでlockせざるを得ないが．\nこの問題についてはpipenvの開発者も認識しているらしく，近い将来改善されることが期待される．\nもう一つの仮想環境に入るの面倒あるいわかりづらい問題は，\n自分のターミナルを適応させることでなんとかなると思う．\nというかそういうの考えるのは割と好き．\u003c/p\u003e\n\u003ch1 id=\"まとめ\"\u003eまとめ\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e開発環境さえ整えばdockerが最高！(と思う)\u003c/li\u003e\n\u003cli\u003eパッケージ管理特化のツールはpipenvが一つ抜けている気もするが，(まだ)五十歩百歩\u003c/li\u003e\n\u003cli\u003eanacondaは好き嫌い分かれてる\u003c/li\u003e\n\u003cli\u003e開発環境を完璧に整えるのはdockerに限らず難しい\u003c/li\u003e\n\u003c/ul\u003e","ogImage":{"url":"/assets/blog/dynamic-routing/cover.jpg"},"coverImage":"/assets/blog/dynamic-routing/cover.jpg"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2019-06-16-python_env"},"buildId":"yNrEyh5A0Oyk3eJQw5kY9","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>