<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#fdf6e3"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#fdf6e3"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description"/><meta property="og:title" content="GitHub ActionsでCHANGELOG駆動Release"/><meta property="og:type" content="website"/><meta property="og:url" content="{DOMAIN}/posts/2021-03-07-github_actions_tag_release_changelog"/><meta property="og:description"/><meta property="og:image" content="https://og-image.vercel.app/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta property="og:image:alt"/><meta property="og:site_name" content="dondakeshimoの丸太"/><meta property="og:locale" content="ja_JP"/><meta property="twitter:card" content="summary_large_image"/><meta property="twitter:title" content="GitHub ActionsでCHANGELOG駆動Release"/><meta property="twitter:description"/><meta property="twitter:image" content="https://og-image.vercel.app/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta property="twitter:image:alt"/><meta property="twitter:site" content="dondakeshimo"/><meta property="twitter:creator" content="dondakeshimo"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><title>GitHub ActionsでCHANGELOG駆動Release | dondakeshimoの丸太</title><meta property="og:image" content="/assets/blog/dynamic-routing/cover.jpg"/><meta name="next-head-count" content="31"/><link rel="preload" href="/_next/static/css/0f9d9436e0b0760d86ae.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0f9d9436e0b0760d86ae.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/framework-2191d16384373197bc0a.js" defer=""></script><script src="/_next/static/chunks/main-c034215587cd157b2989.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d2622b3552023a29a89a.js" defer=""></script><script src="/_next/static/chunks/cb1608f2-854db26f8877d6c8528f.js" defer=""></script><script src="/_next/static/chunks/a9a7754c-ecd5c258dd80f13aa656.js" defer=""></script><script src="/_next/static/chunks/349-e0275456508bca40c658.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-c414199f8f835e5668ae.js" defer=""></script><script src="/_next/static/yNrEyh5A0Oyk3eJQw5kY9/_buildManifest.js" defer=""></script><script src="/_next/static/yNrEyh5A0Oyk3eJQw5kY9/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="min-h-vfull"><main><div class="full-container mx-auto px-5"><a class="text-l font-bold text-tight mb-xl mt-l"><a class="logo" href="/"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="hand-point-up" class="svg-inline--fa fa-hand-point-up fa-w-12 svg-l dondake-icon" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M135.652 0c23.625 0 43.826 20.65 43.826 44.8v99.851c17.048-16.34 49.766-18.346 70.944 6.299 22.829-14.288 53.017-2.147 62.315 16.45C361.878 158.426 384 189.346 384 240c0 2.746-.203 13.276-.195 16 .168 61.971-31.065 76.894-38.315 123.731C343.683 391.404 333.599 400 321.786 400H150.261l-.001-.002c-18.366-.011-35.889-10.607-43.845-28.464C93.421 342.648 57.377 276.122 29.092 264 10.897 256.203.008 242.616 0 224c-.014-34.222 35.098-57.752 66.908-44.119 8.359 3.583 16.67 8.312 24.918 14.153V44.8c0-23.45 20.543-44.8 43.826-44.8zM136 416h192c13.255 0 24 10.745 24 24v48c0 13.255-10.745 24-24 24H136c-13.255 0-24-10.745-24-24v-48c0-13.255 10.745-24 24-24zm168 28c-11.046 0-20 8.954-20 20s8.954 20 20 20 20-8.954 20-20-8.954-20-20-20z"></path></svg>dondakeshimoの丸太</a></a><article class="mb-2xl"><h1 class="title text-xl font-bold mb-l text-center">GitHub ActionsでCHANGELOG駆動Release</h1><div class="container-80 mx-auto"><div class="mb-l text-l"><time dateTime="2021-03-07">March	7, 2021</time></div></div><div class="container-80 mx-auto"><div><h1 id="目次">目次</h1>
<ul>
<li><a href="#%E6%A6%82%E8%A6%81">概要</a></li>
<li><a href="#%E6%89%8B%E6%B3%95">手法</a>
<ul>
<li>
<ul>
<li><a href="#changelog">CHANGELOG</a></li>
<li><a href="#action%E5%AE%9A%E7%BE%A9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB">Action定義ファイル</a></li>
<li><a href="#%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88">ポイント</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E6%88%A6%E7%95%A5">基本戦略</a></li>
<li><a href="#git-fetch---unshallow">git fetch --unshallow</a></li>
<li><a href="#outputs-%E3%81%A8-">outputs と <code>*</code></a></li>
<li><a href="#%E8%AA%B2%E9%A1%8C">課題</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
</ul>
<h1 id="概要">概要</h1>
<p>GitHub Actionsというサービスがある。
サービス自体の説明についてはここでは触れない。
本ポストのテーマはタイトルの通り、CHANGELOGを用いたリリースおよびタグの管理だ。</p>
<p>タグがpushされたタイミングで、それまでのcommitを自動で読み取りCHANGELOG.mdおよびReleaseを発行してくれるという
至れり尽くせりなGitHub Actionsの例は各所で見受けられるが、
正直自分としてはcommitログそのままReleaseに書かれるとか嫌だし、
tagをpushするよりもReleaseの履歴がわかりやすくあってほしい。
要するに、tagが発行されたタイミングではなくCHANGELOGを修正したタイミングで、
CHANGELOGに応じた諸々のリリースフローを行ってほしいわけである。</p>
<p>まとめると</p>
<ul>
<li>CHANGELOG.mdが修正されたcommitがmasterにpushされたタイミングでActionが起動</li>
<li>CHANGELOG.mdに記載されているVersionのtagを発行</li>
<li>CHANGELOG.mdに記載されている内容のReleaseを発行</li>
</ul>
<p>というGitHub Actionsを作るぞという話。</p>
<h1 id="手法">手法</h1>
<h3 id="changelog">CHANGELOG</h3>
<p>下記のようなCHANGELOG.mdを想定している。</p>
<pre><code>## Version 0.1.0
* akanechan kawaii yatta-
* add choco mint ices

## Version 0.0.2
* fix release flow

## Version 0.0.1
* initial application version
</code></pre>
<h3 id="action定義ファイル">Action定義ファイル</h3>
<p>上記のCHANGELOG.mdに対してのAction定義ファイル。
<code>Extract CHANGELOG</code> stepを適当にいじれば大体のCHANGELOG.mdの書き方に対応できると思われる。</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Release

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> master <span class="token punctuation">]</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'CHANGELOG.md'</span><span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>

  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Release
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check out
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Extract CHANGELOG
      <span class="token key atrule">id</span><span class="token punctuation">:</span> versioning
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        VERSION=$(head -1 CHANGELOG.md | sed -e 's/^.*Version //g')
        git fetch --prune --unshallow
        PRETAG=$(git describe --tags --abbrev=0)
        git diff $PRETAG..${{ github.sha }} -- CHANGELOG.md | grep -E '^\+' | grep -v '+++' | sed -e 's/^\+//g' > diff-changelog.txt
        echo ::set-output name=version::$VERSION</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Tag
      <span class="token key atrule">id</span><span class="token punctuation">:</span> tag_version
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> mathieudutour/github<span class="token punctuation">-</span>tag<span class="token punctuation">-</span>action@v5.2
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">custom_tag</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.versioning.outputs.version <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">github_token</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">files</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          CHANGELOG.md
          LICENSE</span>
        <span class="token key atrule">tag_name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.tag_version.outputs.new_tag <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">body_path</span><span class="token punctuation">:</span> diff<span class="token punctuation">-</span>changelog.txt
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="ポイント">ポイント</h3>
<h4 id="基本戦略">基本戦略</h4>
<ul>
<li>1行目の文字列から <code>Version </code> 以降の文字列を抽出しversionとする</li>
<li>前回のtagとの差分をReleaseのdescriptionとする</li>
</ul>
<h4 id="git-fetch---unshallow">git fetch --unshallow</h4>
<p>GitHub Actionsを使用していれば大概の場合使うであろう <code>actions/checkout</code> actionだが、
こちらでcloneしているリポジトリは <em>shallow repository</em> である。
履歴情報がないので、そのままでは <code>git diff</code> やら <code>git describe --tags</code> をしても空振りに終わってしまう。</p>
<pre><code>git fetch --unshallow
</code></pre>
<p>をしてあげることで過去の変更履歴を取得して、前回のtagからの変更履歴が参照できるようにする。</p>
<h4 id="outputs-と-">outputs と <code>*</code></h4>
<pre><code>echo ::set-output name=version::$VERSION
</code></pre>
<p>という構文を用いれば、stepから情報を出力できる。
基本的にはこの手法を用いてstep間で情報の授受をすれば問題ないと思われる。</p>
<p>しかし、CHAGELOGの情報をoutputsに宣言した際、 <code>*</code> がファイル名に展開されてしまっていた。
いまいち原因は調べきれていないので、詳しい方いたら理由を教えていただけると幸いである。</p>
<p>対応策として、CHANGELOGの差分情報はファイルに書き出して、ファイル経由で情報の伝播を行うようにした。</p>
<h4 id="課題">課題</h4>
<p>validation等は一切していないので、1行目が前と同じversionの状態でmasterへマージしてしまったりすると、
tagの上書きが発生してしまうと思われるのでCHANGELOGの修正には注意が必要。(一敗)</p>
<h1 id="まとめ">まとめ</h1>
<p>CHANGELOGの修正をトリガーとし、CHANGELOGの内容に従ったtagとReleaseを発行することができた。
tagやReleaseの発行は外部Actionを使用しており、正直どこまで外部Actionに頼っていいかは疑問だし、不安の種でもある。
まあ、GitHub自体が破壊的なAPIの変更等を加えない限り同様のバージョンを使い続けていれば不慮の事故は起こらないと信じたい。</p></div></div></article></div></main></div><footer><div class="full-container mx-auto px-5"><div class="full-container mx-auto px-5"><div class="py-m sns-container my-l"><div class="mx-s github-icon"><a href="https://github.com/dondakeshimo"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div><div class="mx-s twitter-icon"><a href="https://twitter.com/dondakeshimo"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"GitHub ActionsでCHANGELOG駆動Release","date":"2021-03-07","slug":"2021-03-07-github_actions_tag_release_changelog","author":{"name":"JJ Kasper","picture":"/assets/blog/authors/jj.jpeg"},"content":"\u003ch1 id=\"目次\"\u003e目次\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e概要\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%89%8B%E6%B3%95\"\u003e手法\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#changelog\"\u003eCHANGELOG\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#action%E5%AE%9A%E7%BE%A9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\"\u003eAction定義ファイル\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\"\u003eポイント\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%9F%BA%E6%9C%AC%E6%88%A6%E7%95%A5\"\u003e基本戦略\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#git-fetch---unshallow\"\u003egit fetch --unshallow\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#outputs-%E3%81%A8-\"\u003eoutputs と \u003ccode\u003e*\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e課題\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"概要\"\u003e概要\u003c/h1\u003e\n\u003cp\u003eGitHub Actionsというサービスがある。\nサービス自体の説明についてはここでは触れない。\n本ポストのテーマはタイトルの通り、CHANGELOGを用いたリリースおよびタグの管理だ。\u003c/p\u003e\n\u003cp\u003eタグがpushされたタイミングで、それまでのcommitを自動で読み取りCHANGELOG.mdおよびReleaseを発行してくれるという\n至れり尽くせりなGitHub Actionsの例は各所で見受けられるが、\n正直自分としてはcommitログそのままReleaseに書かれるとか嫌だし、\ntagをpushするよりもReleaseの履歴がわかりやすくあってほしい。\n要するに、tagが発行されたタイミングではなくCHANGELOGを修正したタイミングで、\nCHANGELOGに応じた諸々のリリースフローを行ってほしいわけである。\u003c/p\u003e\n\u003cp\u003eまとめると\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCHANGELOG.mdが修正されたcommitがmasterにpushされたタイミングでActionが起動\u003c/li\u003e\n\u003cli\u003eCHANGELOG.mdに記載されているVersionのtagを発行\u003c/li\u003e\n\u003cli\u003eCHANGELOG.mdに記載されている内容のReleaseを発行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eというGitHub Actionsを作るぞという話。\u003c/p\u003e\n\u003ch1 id=\"手法\"\u003e手法\u003c/h1\u003e\n\u003ch3 id=\"changelog\"\u003eCHANGELOG\u003c/h3\u003e\n\u003cp\u003e下記のようなCHANGELOG.mdを想定している。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e## Version 0.1.0\n* akanechan kawaii yatta-\n* add choco mint ices\n\n## Version 0.0.2\n* fix release flow\n\n## Version 0.0.1\n* initial application version\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"action定義ファイル\"\u003eAction定義ファイル\u003c/h3\u003e\n\u003cp\u003e上記のCHANGELOG.mdに対してのAction定義ファイル。\n\u003ccode\u003eExtract CHANGELOG\u003c/code\u003e stepを適当にいじれば大体のCHANGELOG.mdの書き方に対応できると思われる。\u003c/p\u003e\n\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Release\n\n\u003cspan class=\"token key atrule\"\u003eon\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003ebranches\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e master \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003epaths\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'CHANGELOG.md'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"token key atrule\"\u003ejobs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\n  \u003cspan class=\"token key atrule\"\u003ebuild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Release\n    \u003cspan class=\"token key atrule\"\u003eruns-on\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ubuntu\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003elatest\n    \u003cspan class=\"token key atrule\"\u003esteps\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Check out\n      \u003cspan class=\"token key atrule\"\u003euses\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e actions/checkout@v2\n\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Extract CHANGELOG\n      \u003cspan class=\"token key atrule\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e versioning\n      \u003cspan class=\"token key atrule\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e\u003cspan class=\"token scalar string\"\u003e\n        VERSION=$(head -1 CHANGELOG.md | sed -e 's/^.*Version //g')\n        git fetch --prune --unshallow\n        PRETAG=$(git describe --tags --abbrev=0)\n        git diff $PRETAG..${{ github.sha }} -- CHANGELOG.md | grep -E '^\\+' | grep -v '+++' | sed -e 's/^\\+//g' \u003e diff-changelog.txt\n        echo ::set-output name=version::$VERSION\u003c/span\u003e\n\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Tag\n      \u003cspan class=\"token key atrule\"\u003eid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e tag_version\n      \u003cspan class=\"token key atrule\"\u003euses\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e mathieudutour/github\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003etag\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eaction@v5.2\n      \u003cspan class=\"token key atrule\"\u003ewith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003ecustom_tag\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e $\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e steps.versioning.outputs.version \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003egithub_token\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e $\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e secrets.GITHUB_TOKEN \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Release\n      \u003cspan class=\"token key atrule\"\u003euses\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e softprops/action\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003egh\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003erelease@v1\n      \u003cspan class=\"token key atrule\"\u003ewith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003efiles\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e\u003cspan class=\"token scalar string\"\u003e\n          CHANGELOG.md\n          LICENSE\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003etag_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e $\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e steps.tag_version.outputs.new_tag \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003ebody_path\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e diff\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003echangelog.txt\n      \u003cspan class=\"token key atrule\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003eGITHUB_TOKEN\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e $\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e secrets.GITHUB_TOKEN \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"ポイント\"\u003eポイント\u003c/h3\u003e\n\u003ch4 id=\"基本戦略\"\u003e基本戦略\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e1行目の文字列から \u003ccode\u003eVersion \u003c/code\u003e 以降の文字列を抽出しversionとする\u003c/li\u003e\n\u003cli\u003e前回のtagとの差分をReleaseのdescriptionとする\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"git-fetch---unshallow\"\u003egit fetch --unshallow\u003c/h4\u003e\n\u003cp\u003eGitHub Actionsを使用していれば大概の場合使うであろう \u003ccode\u003eactions/checkout\u003c/code\u003e actionだが、\nこちらでcloneしているリポジトリは \u003cem\u003eshallow repository\u003c/em\u003e である。\n履歴情報がないので、そのままでは \u003ccode\u003egit diff\u003c/code\u003e やら \u003ccode\u003egit describe --tags\u003c/code\u003e をしても空振りに終わってしまう。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003egit fetch --unshallow\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eをしてあげることで過去の変更履歴を取得して、前回のtagからの変更履歴が参照できるようにする。\u003c/p\u003e\n\u003ch4 id=\"outputs-と-\"\u003eoutputs と \u003ccode\u003e*\u003c/code\u003e\u003c/h4\u003e\n\u003cpre\u003e\u003ccode\u003eecho ::set-output name=version::$VERSION\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eという構文を用いれば、stepから情報を出力できる。\n基本的にはこの手法を用いてstep間で情報の授受をすれば問題ないと思われる。\u003c/p\u003e\n\u003cp\u003eしかし、CHAGELOGの情報をoutputsに宣言した際、 \u003ccode\u003e*\u003c/code\u003e がファイル名に展開されてしまっていた。\nいまいち原因は調べきれていないので、詳しい方いたら理由を教えていただけると幸いである。\u003c/p\u003e\n\u003cp\u003e対応策として、CHANGELOGの差分情報はファイルに書き出して、ファイル経由で情報の伝播を行うようにした。\u003c/p\u003e\n\u003ch4 id=\"課題\"\u003e課題\u003c/h4\u003e\n\u003cp\u003evalidation等は一切していないので、1行目が前と同じversionの状態でmasterへマージしてしまったりすると、\ntagの上書きが発生してしまうと思われるのでCHANGELOGの修正には注意が必要。(一敗)\u003c/p\u003e\n\u003ch1 id=\"まとめ\"\u003eまとめ\u003c/h1\u003e\n\u003cp\u003eCHANGELOGの修正をトリガーとし、CHANGELOGの内容に従ったtagとReleaseを発行することができた。\ntagやReleaseの発行は外部Actionを使用しており、正直どこまで外部Actionに頼っていいかは疑問だし、不安の種でもある。\nまあ、GitHub自体が破壊的なAPIの変更等を加えない限り同様のバージョンを使い続けていれば不慮の事故は起こらないと信じたい。\u003c/p\u003e","ogImage":{"url":"/assets/blog/dynamic-routing/cover.jpg"},"coverImage":"/assets/blog/dynamic-routing/cover.jpg"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2021-03-07-github_actions_tag_release_changelog"},"buildId":"yNrEyh5A0Oyk3eJQw5kY9","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>